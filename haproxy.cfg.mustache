# Generated by rwindegger/swarm-gen

global
	maxconn 256
	tune.ssl.default-dh-param 2048

defaults
	mode http
	log global
	option http-server-close
	option abortonclose
	option dontlognull
	option httpclose
	option httplog
	option forwardfor
	option redispatch
	timeout connect 5000ms
	timeout client 50000ms
	timeout server 50000ms
	stats enable

frontend http-in
	bind *:80
	acl is_certbot path_beg /.well-known/acme-challenge
	use_backend certbot if is_certbot
	use_backend %[req.hdr(host),lower,map(/usr/local/etc/haproxy/host.map,default)] if !is_certbot

{{#enableSSL}}
frontend https-in
	bind *:443 ssl crt /usr/local/etc/haproxy/certificates
	acl is_certbot path_beg /.well-known/acme-challenge
	use_backend certbot if is_certbot
	use_backend %[req.hdr(host),lower,map(/usr/local/etc/haproxy/host.map,default)] if !is_certbot
	
{{/enableSSL}}
backend certbot
	server certbot {{certhost}}:80 maxconn 15
	
backend default
	errorfile 503 /usr/local/etc/haproxy/invalid.http
{{#services}}
	{{#isActive}}
	
backend {{name}}
	balance roundrobin
	cookie {{name}}_stick insert indirect nocache
	http-request set-header X-Forwarded-Port %[dst_port]
	http-request add-header X-Forwarded-Proto https if { ssl_fc }
	option httpchk HEAD / HTTP/1.1\r\nHost:{{host}}
		{{#tasks}}
	server {{id}} {{hostname}}:{{port}} maxconn 15 check inter 10000 cookie {{id}}
		{{/tasks}}
	{{/isActive}}
{{/services}}
