# Generated by rwindegger/swarm-gen

global
	maxconn 256

defaults
	mode http
	log global
	option abortonclose
	option dontlognull
	option httpclose
	option httplog
	option forwardfor
	option redispatch
	timeout connect 5000ms
	timeout client 50000ms
	timeout server 50000ms
	http-request set-header X-Forwarded-Port %[dst_port]
	http-request add-header X-Forwarded-Proto https if { ssl_fc }
	stats enable

frontend http-in
	bind *:80
	use_backend %[req.hdr(host),lower,map(/usr/local/etc/haproxy/host.map,default)]

backend default
	errorfile 503 /usr/local/etc/haproxy/invalid.http
{{#services}}
	{{#tasks.length}}
	
backend {{name}}
	balance roundrobin
	cookie {{name}}_stick insert indirect nocache
	option httpchk HEAD / HTTP/1.1\r\nHost:{{host}}
		{{#tasks}}
	server {{id}} {{hostname}}:{{port}} maxconn 15 check inter 10000 cookie {{id}}
		{{/tasks}}
	{{/tasks.length}}
{{/services}}